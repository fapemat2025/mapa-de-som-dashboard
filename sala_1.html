<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Sala 1</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background-color: #ecf0f1; }
        .dashboard-container { max-width: 900px; margin: 20px auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; }
        #dB_atual { font-size: 3em; font-weight: bold; margin: 10px 0; color: #e74c3c; }
        .voltar { text-decoration: none; color: #3498db; margin-bottom: 20px; display: block; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <a href="index.html" class="voltar">‚Üê Voltar ao Mapa Geral</a>
    <div class="dashboard-container">
        <h1>Dashboard Sala 1</h1>

        <h2>N√≠vel de Ru√≠do Atual (dB):</h2>
        <div id="dB_atual">--</div>

        <div style="width: 100%; height: 400px;">
            <canvas id="realtimeChart"></canvas>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // üö® PASSO CR√çTICO 1: CONFIGURA√á√ÉO DO FIREBASE
        // ----------------------------------------------------
        // SUBSTITUA estas credenciais pelas do seu projeto!
        const firebaseConfig = {
            apiKey: "SEU_API_KEY", 
            authDomain: "SEU_PROJETO.firebaseapp.com",
            databaseURL: "https://mapasesom2025-default-rtdb.firebaseio.com", // SEU HOST REAL
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_BUCKET",
            messagingSenderId: "SEU_ID",
            appId: "SEU_APP_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ----------------------------------------------------
        // PASSO CR√çTICO 2: CONFIGURA√á√ÉO DO GR√ÅFICO
        // ----------------------------------------------------
        const ctx = document.getElementById('realtimeChart').getContext('2d');
        let chartData = {
            labels: [],
            datasets: [{
                label: 'N√≠vel de Ru√≠do (dB)',
                data: [],
                borderColor: '#e74c3c',
                borderWidth: 2,
                fill: false
            }]
        };

        const realtimeChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Tempo'
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: false,
                            min: 20, // dB m√≠nimo
                            max: 100  // dB m√°ximo
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'N√≠vel de Ru√≠do (dB)'
                        }
                    }]
                }
            }
        });

        // ----------------------------------------------------
        // üö® PASSO CR√çTICO 3: LEITURA DE DADOS DO FIREBASE
        // ----------------------------------------------------
        
        // üéØ L√ä OS DADOS DO N√ì CORRETO: /leituras/Sala_1
        const salaRef = database.ref('leituras/Sala_1').limitToLast(60); // Limita aos √∫ltimos 60 registros (2 minutos de dados)

        salaRef.on('value', (snapshot) => {
            const dadosSala = snapshot.val();
            let labels = [];
            let data = [];
            let ultimo_db = '--';

            for (const key in dadosSala) {
                const registro = dadosSala[key];
                
                // ‚ö†Ô∏è CORRE√á√ÉO CR√çTICA DO TIMESTAMP: Multiplica por 1000 para converter Segundos em Milissegundos
                const dataHora = new Date(registro.timestamp * 1000); 
                
                labels.push(dataHora);
                data.push(registro.db);
                
                // Pega o √∫ltimo dB lido (que ser√° o mais recente)
                ultimo_db = registro.db.toFixed(1); 
            }

            // Atualiza o valor atual na tela
            document.getElementById('dB_atual').innerText = ultimo_db;

            // Atualiza o gr√°fico
            realtimeChart.data.labels = labels;
            realtimeChart.data.datasets[0].data = data;
            realtimeChart.update();
        });

    </script>
</body>
</html>
