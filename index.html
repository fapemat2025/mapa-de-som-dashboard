#include <WiFi.h>
#include <WebServer.h>
#include <FirebaseESP32.h>
#include <time.h>

// ===================================
// 1. CONFIGURAÇÃO DA SALA (MUDE AQUI!)
// ===================================
// IMPORTANTE: Mude para "sala2", "sala3", etc. nos outros ESPs
String SENSOR_ID = "sala1";


// ===================================
// 2. CONFIGURAÇÕES DE REDE E FIREBASE
// ===================================

// Configuração do WiFi
const char* ssid = "alunos-e-e-militar-dom-pedro-ii";
const char* password = "Milit@r2022";

// Configuração do Firebase
#define FIREBASE_HOST "mapasesom2025-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH "yBe1k678KMGvygizrLbMLNkQzRYsWF0umQP3T693"

FirebaseConfig firebaseConfig;
FirebaseAuth firebaseAuth;
FirebaseData firebaseData;

// Parâmetros do NTP (GMT-3, Horário de Brasília)
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = -10800;
const int daylightOffset_sec = 0;

// ===================================
// 3. CONFIGURAÇÃO DE HARDWARE
// ===================================
const int micAnalog = 34; // PINO DO MAX9814
WebServer server(80);

// ===================================
// 4. FUNÇÕES NTP / TIMESTAMP
// ===================================

void iniciarNTP() {
    configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
    Serial.print("Sincronizando NTP");
    time_t now = time(nullptr);
   
    // Tenta por 10 segundos, se não conseguir segue a vida (para não travar boot)
    int retry = 0;
    while (now < 1700000000 && retry < 20) {
        Serial.print(".");
        delay(500);
        now = time(nullptr);
        retry++;
    }
    Serial.println("\nNTP Concluido (ou timeout).");
}

unsigned long long getEpochSeconds() {
    struct timeval tv;
    gettimeofday(&tv, NULL);
    return (unsigned long long) tv.tv_sec;
}

// ===================================
// 5. FUNÇÕES SENSOR
// ===================================

int lerPicoMAX9814() {
    int pico = 0;
    for (int i = 0; i < 100; i++) {
        int val = analogRead(micAnalog);
        if (val > pico) pico = val;
        delayMicroseconds(150);
    }
    return pico;
}

float converterParaDB(int adc) {
    // Ajuste aqui conforme sua calibração real
    return map(adc, 1450, 3300, 25, 100);
}

// ===================================
// 6. ROTAS WEB (Debug Local)
// ===================================

const char siteHTML[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Sensor Local</title></head>
<body><h2>Sensor Ativo</h2><p>Vá para /data para ver o JSON.</p></body>
</html>
)rawliteral";

void handleRoot() {
    server.send_P(200, "text/html", siteHTML);
}

void handleData() {
    int adc = lerPicoMAX9814();
    float db = constrain(converterParaDB(adc), 25.0, 100.0);
    String json = "{\"id\":\"" + SENSOR_ID + "\", \"adc\":" + String(adc) + ", \"db\":" + String(db, 1) + "}";
    server.send(200, "application/json", json);
}

// ===================================
// 7. SETUP
// ===================================
void setup() {
    Serial.begin(115200);

    analogReadResolution(12);
    analogSetPinAttenuation(micAnalog, ADC_11db);

    // --- WIFI ---
    WiFi.begin(ssid, password);
    Serial.print("Conectando ao WiFi");
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("\nWiFi conectado: " + WiFi.localIP().toString());

    // --- NTP ---
    iniciarNTP();

    // --- FIREBASE ---
    firebaseConfig.database_url = FIREBASE_HOST;
    firebaseConfig.signer.tokens.legacy_token = FIREBASE_AUTH;
   
    // Configurações para manter a conexão estável
    firebaseData.setBSSLBufferSize(1024, 1024);
    firebaseData.setResponseSize(1024);

    Firebase.begin(&firebaseConfig, &firebaseAuth);
    Firebase.reconnectWiFi(true);

    // --- SERVIDOR WEB ---
    server.on("/", handleRoot);
    server.on("/data", handleData);
    server.begin();
    Serial.println("Servidor iniciado.");
}

// ===================================
// 8. LOOP PRINCIPAL
// ===================================
void loop() {
    server.handleClient();

    // 1. Leitura
    int adc = lerPicoMAX9814();
    float db = constrain(converterParaDB(adc), 25.0, 100.0);
    unsigned long long timestamp_s = getEpochSeconds();

    // Debug Serial
    Serial.printf("[%s] ADC: %d | dB: %.1f\n", SENSOR_ID.c_str(), adc, db);

    // 2. Envio Firebase
    if (Firebase.ready()) {
        FirebaseJson json;

        // Dados do Payload
        json.set("timestamp", (uint64_t) timestamp_s);
        json.set("adc", adc);
        json.set("db", db);
       
        // (Opcional) Lat/Lon fixos podem ser removidos para economizar dados se não usar no mapa
        // json.set("lat", -23.5505);
        // json.set("lon", -46.6333);

        // --- MUDANÇA CRÍTICA AQUI ---
        // Define o caminho dinâmico: /sensors/sala1/leituras
        String path = "/sensors/" + SENSOR_ID + "/leituras";

        if (Firebase.pushJSON(firebaseData, path, json)) {
             Serial.println(">> Enviado para: " + path);
        } else {
             Serial.print(">> ERRO Firebase: ");
             Serial.println(firebaseData.errorReason());
        }
    }

    delay(2000); // Intervalo de envio
}
