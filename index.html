<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Central de Monitoramento Sonoro</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ========== ESTILOS GERAIS ========== */
body {
    margin: 0;
    padding: 0;
    background: #F5F7FB;
    font-family: 'Inter', sans-serif;
    color: #333;
}

.header {
    background: #0D6EFD;
    padding: 16px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header-title {
    font-size: 20px;
    font-weight: 600;
}

.back-btn {
    display: none;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
.back-btn:hover {
    background: rgba(255,255,255,0.3);
}

.container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

/* ========== MAPA GERAL ========== */
#view-map {
    display: block;
}

.sensor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.sensor-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border-left: 6px solid #ccc;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.sensor-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

/* Agrupamento dos valores */
.sensor-value-group {
    margin-top: 10px;
    margin-bottom: 10px;
    flex-grow: 1;
}

.sensor-name {
    font-size: 16px;
    font-weight: 700;
    color: #555;
    margin-bottom: 5px;
    text-transform: uppercase;
}
.sensor-value {
    font-size: 42px;
    font-weight: 800;
    color: #333;
}
.sensor-status {
    font-size: 14px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-top: 10px;
}
.sensor-update {
    font-size: 12px;
    color: #999;
    margin-top: 10px;
}
.sensor-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 24px;
    opacity: 0.2;
}

/* Cores de Status */
.status-normal {
    color: #2ECC71;
    background: rgba(46, 204, 113, 0.1);
}
.status-atencao {
    color: #F1C40F;
    background: rgba(241, 196, 15, 0.1);
}
.status-alto {
    color: #E74C3C;
    background: rgba(231, 76, 60, 0.1);
}

/* ========== DASHBOARD DETALHADO ========== */
#view-detail {
    display: none;
}

.detail-layout {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}
.left {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.right {
    width: 320px;
    min-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.card-header-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}
.card-title {
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 700;
    color: #555;
    margin: 0;
}

/* Filtros da Tabela */
.table-filters {
    display: flex;
    gap: 5px;
}
.tf-btn {
    border: 1px solid #ddd;
    background: #f9f9f9;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    color: #666;
    cursor: pointer;
}
.tf-btn:hover {
    background: #eee;
}
.tf-btn.active {
    color: white;
    border-color: transparent;
}
.tf-btn[data-filter="all"].active {
    background: #333;
}
.tf-btn[data-filter="normal"].active {
    background: #2ECC71;
}
.tf-btn[data-filter="atencao"].active {
    background: #F1C40F;
}
.tf-btn[data-filter="alto"].active {
    background: #E74C3C;
}

.graph-card {
    height: 400px;
}
#chart {
    width: 100% !important;
    height: 100% !important;
}

.value-display {
    font-size: 48px;
    font-weight: 700;
    color: #0D6EFD;
    text-align: center;
}
.mini-bar {
    height: 12px;
    border-radius: 6px;
    background: #eee;
    margin-top: 5px;
}

/* Filtros de tempo */
.filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}
.filter-btn {
    padding: 6px 12px;
    font-size: 12px;
    border: 1px solid #0D6EFD;
    background: transparent;
    color: #0D6EFD;
    border-radius: 20px;
    cursor: pointer;
}
.filter-btn.active {
    background: #0D6EFD;
    color: white;
}

.table-container {
    max-height: 250px;
    overflow: auto;
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
thead {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
td, th {
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

/* Responsivo */
@media (max-width: 800px) {
    .right {
        width: 100%;
        flex-direction: row;
    }
    .right .card {
        flex: 1;
    }
    .sensor-grid {
        grid-template-columns: 1fr;
    }
    .card-header-flex {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
Â  Â  <div class="header-title" id="pageTitle">Mapa Geral de RuÃ­do</div>
Â  Â  <button class="back-btn" id="btnBack">â† Voltar</button>
</div>

<div class="container">

Â  Â  <div id="view-map">
Â  Â  Â  Â  <div class="sensor-grid" id="gridContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="view-detail">
Â  Â  Â  Â  <div class="detail-layout">
Â  Â  Â  Â  Â  Â  <div class="left">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">HistÃ³rico: <span id="currentSensorName">--</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="filters">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn active" data-range="30m">30 min</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-range="1h">1h</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-range="24h">24h</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-range="7d">7 dias</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card graph-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="chart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header-flex">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">Registros Detalhados</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-filters">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tf-btn active" data-filter="all">Todos</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tf-btn" data-filter="normal">Normal</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tf-btn" data-filter="atencao">AtenÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="tf-btn" data-filter="alto">CrÃ­tico</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Hora</th><th>dB</th><th>Status</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tableBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">Ao Vivo</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="valorAtual" class="value-display">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mini-bar" id="barColor"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:center; font-size:12px; color:#999; margin-top:5px;">Tempo Real</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-title">EstatÃ­sticas (PerÃ­odo)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:5px;">Min: <b id="minVal">--</b> dB</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:5px;">Max: <b id="maxVal">--</b> dB</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>MÃ©dia: <b id="avgVal">--</b> dB</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, query, limitToLast, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Credenciais do seu projeto Firebase (mantidas as originais)
const firebaseConfig = {
Â  Â  apiKey: "AIzaSyC7TIITtyZhIfJQ0KUiwdsZsxoZL0C_JFc",
Â  Â  authDomain: "mapasesom2025.firebaseapp.com",
Â  Â  databaseURL: "https://mapasesom2025-default-rtdb.firebaseio.com",
Â  Â  projectId: "mapasesom2025",
Â  Â  storageBucket: "mapasesom2025.appspot.com",
Â  Â  messagingSenderId: "504965389065",
Â  Â  appId: "1:504965389065:web:4ddb06768218c9c6e98780"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// IDs em minÃºsculas (sala1, sala2, etc.) para alinhar com o ESP32
const SENSORS = [
Â  Â  { id: "sala1", name: "Sala 01 - RecepÃ§Ã£o" }, 
Â  Â  { id: "sala2", name: "Sala 02 - ProduÃ§Ã£o" },
Â  Â  { id: "sala3", name: "Sala 03 - ReuniÃ£o" },
Â  Â  { id: "sala4", name: "Sala 04 - Corredor" },
Â  Â  { id: "sala5", name: "Sala 05 - Externa" }
];

/* ================== ESTADO ================== */
let activeSensorId = null;
let activeRange = "30m";
let detailListener = null;

let cachedData = [];Â 
let tableFilter = "all";Â 

/* ================== HELPERS ================== */
function fixTimestamp(ts){
Â  Â  const n = Number(ts);Â 
Â  Â  // Se o timestamp for pequeno (segundos), multiplica por 1000. Se for grande (millis), usa direto.
Â  Â  return isNaN(n) ? Date.now() : (n < 2000000000 ? n * 1000 : n);
}
function formatTime(ts){
Â  Â  return new Date(fixTimestamp(ts)).toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}
function getStatusColor(db){
Â  Â  if(db < 60) return { color: "#2ECC71", text: "Normal", class: "status-normal", border: "#2ECC71", code: "normal" };
Â  Â  if(db < 75) return { color: "#F1C40F", text: "AtenÃ§Ã£o", class: "status-atencao", border: "#F1C40F", code: "atencao" };
Â  Â  return { color: "#E74C3C", text: "CrÃ­tico", class: "status-alto", border: "#E74C3C", code: "alto" };
}

/* ================== MAPA ================== */
const gridContainer = document.getElementById('gridContainer');

function initMap(){
Â  Â  gridContainer.innerHTML = "";
Â  Â  SENSORS.forEach(sensor => {
Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.className = "sensor-card"; 
Â  Â  Â  Â  card.id = `card-${sensor.id}`; 
Â  Â  Â  Â  
        // ğŸš€ AJUSTE DE LAYOUT INTERNO: Adicionando sensor-value-group
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="sensor-name">${sensor.name}</div>
            <div class="sensor-value-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sensor-value" id="val-${sensor.id}">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sensor-status" id="status-${sensor.id}">Offline</div>
            </div>
Â  Â  Â  Â  Â  Â  <div class="sensor-update" id="time-${sensor.id}">--:--</div>
Â  Â  Â  Â  Â  Â  <div class="sensor-icon"></div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  card.addEventListener('click', () => openDetail(sensor));
Â  Â  Â  Â  gridContainer.appendChild(card);

Â  Â  Â  Â  // CORREÃ‡ÃƒO DE SINCRONIZAÃ‡ÃƒO: Path alinhado com o ESP32
Â  Â  Â  Â  const r = query(ref(db, `sensors/${sensor.id}/leituras`), limitToLast(1));
Â  Â  Â  Â Â 
Â  Â  Â  Â  onValue(r, (snap) => {
Â  Â  Â  Â  Â  Â  const data = snap.val();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(!data) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`status-${sensor.id}`).textContent = "Offline / Sem Dados";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`card-${sensor.id}`).style.borderLeftColor = "#ccc";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const reading = Object.values(data)[0];Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valEl = document.getElementById(`val-${sensor.id}`);
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById(`status-${sensor.id}`);
Â  Â  Â  Â  Â  Â  const timeEl = document.getElementById(`time-${sensor.id}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dbVal = Number(reading.db);
Â  Â  Â  Â  Â  Â  const status = getStatusColor(dbVal);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  valEl.textContent = dbVal.toFixed(1) + " dB";
Â  Â  Â  Â  Â  Â  valEl.style.color = status.border;
Â  Â  Â  Â  Â  Â  statusEl.textContent = status.text;
Â  Â  Â  Â  Â  Â  statusEl.className = `sensor-status ${status.class}`;
Â  Â  Â  Â  Â  Â  timeEl.textContent = formatTime(reading.timestamp);
Â  Â  Â  Â  Â  Â  document.getElementById(`card-${sensor.id}`).style.borderLeftColor = status.border;
Â  Â  Â  Â  });
Â  Â  });
}

/* ================== DETALHES ================== */
const ctx = document.getElementById("chart").getContext("2d");
const gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(13, 110, 253, 0.4)');
gradient.addColorStop(1, 'rgba(13, 110, 253, 0.0)');

const chart = new Chart(ctx, {
Â  Â  type: "line",
Â  Â  data: { labels: [], datasets: [{ label: "dB", data: [], borderColor:"#0D6EFD", backgroundColor: gradient, fill:true, tension:0.3, pointRadius:0 }] },
Â  Â  options: { responsive:true, maintainAspectRatio:false, scales:{ x:{display:true, grid:{display:false}}, y:{beginAtZero:false} }, plugins:{legend:{display:false}} }
});

function openDetail(sensor){
Â  Â  activeSensorId = sensor.id;
Â  Â  document.getElementById('currentSensorName').textContent = sensor.name;
Â  Â  document.getElementById('pageTitle').textContent = sensor.name;
Â  Â  document.getElementById('view-map').style.display = 'none';
Â  Â  document.getElementById('view-detail').style.display = 'block';
Â  Â  document.getElementById('btnBack').style.display = 'block';
Â  Â Â 
Â  Â  // Reset Filtros
Â  Â  tableFilter = "all";
Â  Â  document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
Â  Â  document.querySelector('.tf-btn[data-filter="all"]').classList.add('active');

Â  Â  loadDashboardData();
}

function loadDashboardData(){
Â  Â  if(detailListener) { off(detailListener); detailListener = null; }
Â  Â  let limit = 100;
Â  Â  if(activeRange === "24h") limit = 2000;
Â  Â  if(activeRange === "7d") limit = 5000;

Â  Â  // CORREÃ‡ÃƒO DE SINCRONIZAÃ‡ÃƒO: Path alinhado com o ESP32
Â  Â  const r = query(ref(db, `sensors/${activeSensorId}/leituras`), limitToLast(limit));
Â  Â  detailListener = r;

Â  Â  onValue(r, (snap) => {
Â  Â  Â  Â  const data = snap.val();
Â  Â  Â  Â  if(!data) {
Â  Â  Â  Â  Â  Â  cachedData = [];
Â  Â  Â  Â  Â  Â  renderTable();
Â  Â  Â  Â  Â  Â  // Limpa dados em tempo real
Â  Â  Â  Â  Â  Â  document.getElementById('valorAtual').textContent = "--";
Â  Â  Â  Â  Â  Â  document.getElementById('barColor').style.background = "#eee";
Â  Â  Â  Â  Â  Â  document.getElementById('minVal').textContent = "--";
Â  Â  Â  Â  Â  Â  document.getElementById('maxVal').textContent = "--";
Â  Â  Â  Â  Â  Â  document.getElementById('avgVal').textContent = "--";
Â  Â  Â  Â  Â  Â  chart.data.labels = [];
Â  Â  Â  Â  Â  Â  chart.data.datasets[0].data = [];
Â  Â  Â  Â  Â  Â  chart.update();

Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const arr = Object.values(data);
Â  Â  Â  Â  arr.sort((a,b)=> fixTimestamp(a.timestamp) - fixTimestamp(b.timestamp));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva para filtrar a tabela depois
Â  Â  Â  Â  cachedData = arr;

Â  Â  Â  Â  // 1. Ao Vivo
Â  Â  Â  Â  const last = arr[arr.length-1];
Â  Â  Â  Â  const lastVal = Number(last.db);
Â  Â  Â  Â  document.getElementById('valorAtual').textContent = lastVal.toFixed(1) + " dB";
Â  Â  Â  Â  document.getElementById('barColor').style.background = getStatusColor(lastVal).border;

Â  Â  Â  Â  // 2. Stats
Â  Â  Â  Â  const vals = arr.map(v=>Number(v.db));
Â  Â  Â  Â  document.getElementById('minVal').textContent = Math.min(...vals).toFixed(1);
Â  Â  Â  Â  document.getElementById('maxVal').textContent = Math.max(...vals).toFixed(1);
Â  Â  Â  Â  document.getElementById('avgVal').textContent = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);

Â  Â  Â  Â  // 3. GrÃ¡fico (Sempre mostra tudo para dar contexto)
Â  Â  Â  Â  let chartData = arr;
Â  Â  Â  Â  if(arr.length > 200) {
Â  Â  Â  Â  Â  Â  chartData = [];
Â  Â  Â  Â  Â  Â  const step = Math.ceil(arr.length / 150);
Â  Â  Â  Â  Â  Â  for(let i=0; i<arr.length; i+=step) chartData.push(arr[i]);
Â  Â  Â  Â  }
Â  Â  Â  Â  chart.data.labels = chartData.map(v => formatTime(v.timestamp));
Â  Â  Â  Â  chart.data.datasets[0].data = chartData.map(v => Number(v.db));
Â  Â  Â  Â  chart.update();

Â  Â  Â  Â  // 4. Renderiza Tabela (com filtro atual)
Â  Â  Â  Â  renderTable();
Â  Â  });
}

function renderTable(){
Â  Â  const tbody = document.getElementById('tableBody');
Â  Â  tbody.innerHTML = "";
Â  Â Â 
Â  Â  // 1. Aplica o filtro selecionado
Â  Â  const filtered = cachedData.filter(item => {
Â  Â  Â  Â  if(tableFilter === "all") return true;
Â  Â  Â  Â  const code = getStatusColor(Number(item.db)).code;
Â  Â  Â  Â  return code === tableFilter;
Â  Â  });

Â  Â  // 2. Se vazio
Â  Â  if(filtered.length === 0){
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;color:#999'>Nenhum registro com este status.</td></tr>";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. Renderiza os Ãºltimos 50 do filtro
Â  Â  filtered.slice(-50).reverse().forEach(v => {
Â  Â  Â  Â  const rowVal = Number(v.db);
Â  Â  Â  Â  const rowSt = getStatusColor(rowVal);
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `<td>${formatTime(v.timestamp)}</td><td><b>${rowVal.toFixed(1)}</b></td><td><span class="sensor-status ${rowSt.class}">${rowSt.text}</span></td>`;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  });
}

// Listeners Filtros da Tabela
document.querySelectorAll('.tf-btn').forEach(btn => {
Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  tableFilter = btn.dataset.filter;
Â  Â  Â  Â  renderTable();
Â  Â  });
});

// Listeners Gerais
document.getElementById('btnBack').addEventListener('click', () => {
Â  Â  document.getElementById('view-map').style.display = 'block';
Â  Â  document.getElementById('view-detail').style.display = 'none';
Â  Â  document.getElementById('btnBack').style.display = 'none';
Â  Â  document.getElementById('pageTitle').textContent = "Mapa Geral de RuÃ­do";
Â  Â  // Desliga o listener detalhado ao voltar para economizar recursos
Â  Â  if(detailListener) { off(detailListener); detailListener = null; }
});

document.querySelectorAll('.filter-btn').forEach(btn => {
Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  activeRange = btn.dataset.range;
Â  Â  Â  Â  loadDashboardData();
Â  Â  });
});

initMap();

</script>
</body>
</html>
