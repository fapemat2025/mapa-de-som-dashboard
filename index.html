<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Som Avançado</title>

<style>
    body {
        margin:0; padding:0;
        background:#F5F7FB;
        font-family:"Inter",sans-serif;
    }

    .header {
        background:#0D6EFD;
        padding:15px;
        color:white;
        font-size:20px;
        font-weight:600;
    }

    .container {
        display:flex;
        gap:20px;
        padding:20px;
        flex-wrap:wrap;
        box-sizing:border-box;
    }

    /* LEFT AREA */
    .left {
        flex:1;
        min-width:350px;
    }

    .card {
        background:white;
        padding:18px;
        border-radius:12px;
        box-shadow:0 1px 4px rgba(0,0,0,0.08);
        margin-bottom:20px;
    }

    .card-title {
        font-size:15px;
        font-weight:600;
        margin-bottom:10px;
        color:#4A4A4A;
    }

    /* FIXED GRAPH SIZE */
    .graph-card {
        height:350px;
        max-height:350px;
        min-height:350px;
        position:relative;
        overflow:hidden; /* Impede estouro */
    }

    #chart {
        width:100% !important;
        height:100% !important;
    }

    /* RIGHT COLUMN */
    .right {
        width:320px;
        min-width:280px;
        display:flex;
        flex-direction:column;
        gap:20px;
    }

    .value-display {
        font-size:42px;
        font-weight:700;
        color:#0D6EFD;
        text-align:center;
        margin-bottom:8px;
    }

    .mini-bar {
        height:8px;
        background:#FFDD57;
        border-radius:5px;
    }

    /* FILTER BUTTONS */
    .filters {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
    }

    .filter-btn {
        padding:6px 10px;
        font-size:12px;
        border:1px solid #0D6EFD;
        background:white;
        color:#0D6EFD;
        border-radius:6px;
        cursor:pointer;
    }

    .filter-btn.active {
        background:#0D6EFD;
        color:white;
    }

    /* TABLE */
    table {
        width:100%;
        border-collapse:collapse;
        font-size:13px;
    }

    thead {
        position:sticky;
        top:0;
        background:#f0f2f8;
        z-index:2;
    }

    td, th { padding:6px 8px; }

    tbody tr:nth-child(even) { background:#f9f9fc; }

    /* MOBILE FIX — RIGHT COLUMN GOES HORIZONTAL */
    @media(max-width:900px){
        .right {
            width:100%;
            flex-direction:row;
        }
        .right .card {
            flex:1;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
</head>

<body>

<div class="header">Dashboard de Nível de Som (SALA 1)</div>

<div class="container">

    <!-- LEFT -->
    <div class="left">

        <div class="card">
            <div class="card-title">Intervalo de Tempo</div>
            <div class="filters">
                <button class="filter-btn active" data-range="30m">Últimos 30 min</button>
                <button class="filter-btn" data-range="1h">Última 1h</button>
                <button class="filter-btn" data-range="24h">Últimas 24h</button>
                <button class="filter-btn" data-range="7d">Última semana</button>
                <button class="filter-btn" data-range="30d">Último mês</button>
            </div>
        </div>

        <div class="card graph-card">
            <div class="card-title">Gráfico - Período Selecionado</div>
            <canvas id="chart"></canvas>
        </div>

        <div class="card">
            <div class="card-title">Tabela de Leituras</div>
            <div style="max-height:240px; overflow-y:auto;">
                <table>
                    <thead>
                        <tr><th>Data/Hora</th><th>dB</th><th>ADC</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- RIGHT -->
    <div class="right">

        <div class="card">
            <div class="card-title">Nível de Som (Ao Vivo)</div>
            <div id="valorAtual" class="value-display">-- dB</div>
            <div class="mini-bar" id="barColor"></div>
        </div>

        <div class="card">
            <div class="card-title">Estatísticas</div>
            <div>Mínimo: <b id="minVal">--</b> dB</div>
            <div>Médio: <b id="avgVal">--</b> dB</div>
            <div>Máximo: <b id="maxVal">--</b> dB</div>
        </div>

    </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, query, limitToLast, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyC7TIITtyZhIfJQ0KUiwdsZsxoZL0C_JFc",
    authDomain: "mapasesom2025.firebaseapp.com",
    databaseURL: "https://mapasesom2025-default-rtdb.firebaseio.com",
    projectId: "mapasesom2025",
    storageBucket: "mapasesom2025.appspot.com",
    messagingSenderId: "504965389065",
    appId: "1:504965389065:web:4ddb06768218c9c6e98780"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const valorAtual = document.getElementById("valorAtual");
const barColor = document.getElementById("barColor");
const minVal = document.getElementById("minVal");
const avgVal = document.getElementById("avgVal");
const maxVal = document.getElementById("maxVal");
const tableBody = document.getElementById("tableBody");

let range = "30m";
let currentListener = null;

const chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{ labels:[], datasets:[{
        label:"Som (dB)",
        data:[],
        borderColor:"#0D6EFD",
        borderWidth:2,
        tension:0.25,
        pointRadius:0
    }]},
    options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        plugins:{ legend:{display:false} }
    }
});

function getLimit() {
    return {
        "30m": 60,
        "1h": 120,
        "24h": 2000,
        "7d": 15000,
        "30d": 60000
    }[range];
}

function formatTime(ts) {
    return new Date(ts * 1000).toLocaleString("pt-BR", {
        year:"2-digit", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit",
        hour12:false,
        timeZone:"America/Sao_Paulo"
    });
}

function update() {

    if (currentListener) off(currentListener);

    const leiturasRef = query(ref(db, "leituras"), limitToLast(getLimit()));
    currentListener = leiturasRef;

    onValue(leiturasRef, snap => {
        const data = snap.val();
        if (!data) return;

        const arr = Object.values(data);
        const last = arr[arr.length-1];

        valorAtual.textContent = last.db.toFixed(1) + " dB";

        barColor.style.background =
            last.db < 50 ? "#2ECC71" :
            last.db < 70 ? "#F1C40F" :
            "#E74C3C";

        chart.data.labels = arr.map(v =>
            new Date(v.timestamp * 1000)
            .toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})
        );

        chart.data.datasets[0].data = arr.map(v => v.db);
        chart.update();

        const values = arr.map(v=>v.db);
        minVal.textContent = Math.min(...values).toFixed(1);
        maxVal.textContent = Math.max(...values).toFixed(1);
        avgVal.textContent = (values.reduce((a,b)=>a+b,0)/values.length).toFixed(1);

        tableBody.innerHTML = "";
        arr.slice().reverse().forEach(v=>{
            tableBody.innerHTML += `
                <tr>
                    <td>${formatTime(v.timestamp)}</td>
                    <td>${v.db.toFixed(1)}</td>
                    <td>${v.raw}</td>
                </tr>
            `;
        });

    });
}

document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        range = btn.dataset.range;
        update();
    };
});

update();

</script>

</body>
</html>
