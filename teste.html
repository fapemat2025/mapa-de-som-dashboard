<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard com dados da Planilha</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <button id="btn-1h">Última 1h</button>
  <button id="btn-24h">Últimas 24h</button>
  <button id="btn-7d">Últimos 7 dias</button>

  <canvas id="chart"></canvas>

  <div id="liveValue">-- dB</div>

  <script type="module">
    // Link da sua planilha publicada como CSV
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHC1DBRKNj95arNy2CDot0fT4YaZWgNRBHFGRQ6Ms4svNAH05eV04ffjXvtRkrZYSdRDuN03ab3UoC/pub?gid=1681540736&single=true&output=csv";

    // Função para buscar e parsear CSV
    async function getSheetData() {
      const res = await fetch(SHEET_CSV_URL);
      const csv = await res.text();
      const lines = csv.trim().split("\n");
      const rows = lines.map(line =>
        line.split(",").map(item => item.trim())
      );
      const headers = rows.shift(); // primeira linha = cabeçalho

      // Supondo colunas: Sensor, Timestamp, Data/Hora, dB, Status
      return rows.map(r => ({
        sensor   : r[0],
        timestamp: Number(r[1]),
        db       : Number(r[3]),
        status   : r[4]
      }));
    }

    function filterByMinutes(data, minutes) {
      const now = Date.now();
      const cutoff = now - minutes * 60 * 1000;
      return data.filter(item => item.timestamp >= cutoff);
    }

    // Inicializa Chart.js
    const ctx = document.getElementById("chart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label: "dB", data: [], borderColor: "#0D6EFD", backgroundColor: "rgba(13,110,253,0.2)", fill: true }] },
      options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: true } } }
    });

    async function updateChartFromSheet(minutes) {
      const data = await getSheetData();
      const filtered = filterByMinutes(data, minutes);
      const labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString("pt-BR"));
      const values = filtered.map(d => d.db);
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
    }

    document.getElementById("btn-1h").onclick  = () => updateChartFromSheet(60);
    document.getElementById("btn-24h").onclick = () => updateChartFromSheet(60 * 24);
    document.getElementById("btn-7d").onclick  = () => updateChartFromSheet(60 * 24 * 7);

    // Exemplo de leitura “Ao Vivo” do Firebase (mantém seu Firebase original)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "…",
      databaseURL: "https://mapasesom2025-default-rtdb.firebaseio.com",
      projectId: "…",
      storageBucket: "…",
      messagingSenderId: "…",
      appId: "…"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const LIVE_SENSOR_ID = "sala3"; // ajuste conforme sensor
    onValue(query(ref(db, `sensors/${LIVE_SENSOR_ID}/leituras`), limitToLast(1)), snap => {
      const data = snap.val();
      if (!data) return;
      const reading = Object.values(data)[0];
      document.getElementById("liveValue").innerText = Number(reading.db).toFixed(1) + " dB";
    });

    // opcional: ao carregar, exibe 1h por padrão
    updateChartFromSheet(60);
  </script>
</body>
</html>
